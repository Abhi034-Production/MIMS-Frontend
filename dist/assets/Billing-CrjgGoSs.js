import{r,A as me,a as D,j as e,L as xe,S as pe,b as he,M as ue,h as q,k as ge,i as be,y as m}from"./index-Ct45hBRj.js";import{E as z}from"./jspdf.es.min-DNBeW_5t.js";import M from"./html2canvas.esm-BfxBtG_O.js";const ve=()=>{const[E,Q]=r.useState([]),[o,f]=r.useState([]),[d,W]=r.useState(""),[x,H]=r.useState(1),[C,I]=r.useState(0),[j,U]=r.useState([]),[p,F]=r.useState({name:"",mobile:"",email:""}),[G,J]=r.useState(""),[l,w]=r.useState(null),[B,v]=r.useState(!1),[u,_]=r.useState(!1),[g,N]=r.useState({}),k=r.useRef(null),[V,A]=r.useState(!1),{user:y}=r.useContext(me),[i,K]=r.useState(null),[X,L]=r.useState(!0);r.useEffect(()=>{!y||!y.email||fetch(`https://mims-backend-x0i3.onrender.com/business-profile/${y.email}`).then(s=>s.json()).then(s=>{s.status==="success"&&K(s.profile)}).catch(()=>{})},[y]),r.useEffect(()=>{D.get("https://mims-backend-x0i3.onrender.com/products").then(s=>Q(s.data)).catch(s=>console.error("Error fetching products:",s))},[]),r.useEffect(()=>{J(new Date().toISOString().slice(0,16))},[]);const R=()=>{L(!0),D.get("https://mims-backend-x0i3.onrender.com/bills").then(s=>{const t=s.data.sort((n,a)=>new Date(a.billDate)-new Date(n.billDate));U(t.slice(0,4))}).catch(s=>console.error("Error fetching recent bills:",s)).finally(()=>L(!1))};r.useEffect(()=>{R()},[]);const Y=()=>{const s=E.find(n=>n._id===d);if(!s)return;const t=g[d]||s.price;if(x>0&&x<=s.quantity){if(o.find(a=>a._id===s._id)){const a=o.map(c=>c._id===s._id?{...c,orderQuantity:c.orderQuantity+x,price:t,totalPrice:(c.orderQuantity+x)*t}:c);f(a)}else{const a={...s,price:t,orderQuantity:x,totalPrice:x*t};f([...o,a])}if(g[d]){const a={...g};delete a[d],N(a)}}else m.error("Invalid quantity or product")};r.useEffect(()=>{const s=o.reduce((t,n)=>t+n.totalPrice,0);I(s)},[o]);const Z=s=>{const t=o.filter(n=>n._id!==s);f(t)},ee=s=>{const{name:t,value:n}=s.target;F({...p,[t]:n})},se=s=>{w(s),A(!1);const t=new window.Image;t.src=i?.businessLogo?`https://mims-backend-x0i3.onrender.com${i.businessLogo}`:"";const n=new window.Image;n.src=i?.businessStamp?`https://mims-backend-x0i3.onrender.com${i.businessStamp}`:"",Promise.all([new Promise(a=>{t.onload=a}),new Promise(a=>{n.onload=a})]).then(()=>{A(!0)})},te=()=>{w(null),v(!1)},O=async()=>{const s=document.querySelector("#invoice-actions");s&&(s.style.display="none");try{const n=(await M(k.current,{scale:1.5,quality:.8,logging:!1,useCORS:!0})).toDataURL("image/jpeg",.8),a=new z("p","mm","a5"),c=a.internal.pageSize.getWidth(),b=a.getImageProperties(n),S=b.height*c/b.width;a.addImage(n,"JPEG",0,0,c,S);const ne=a.output("blob"),T=new FormData;T.append("file",ne,`invoice_${l._id}.pdf`);const $=await(await fetch("https://tmpfiles.org/api/v1/upload",{method:"POST",body:T})).json();if(!$?.data?.url)throw new Error("Failed to upload PDF");const le=$.data.url.replace("tmpfiles.org/","tmpfiles.org/dl/"),oe=l?.customer?.name||"Customer";let h=l?.customer?.mobile||"";h=h.replace(/\D/g,""),h.startsWith("91")||(h="91"+h);const ce=`Hello ${oe},

Here is your invoice from Shop:
${le}

Thank you!`,de=`https://wa.me/${h}?text=${encodeURIComponent(ce)}`;window.open(de,"_blank"),m.success("Invoice shared successfully!")}catch(t){console.error("Error sharing on WhatsApp:",t),m.error("Error sharing invoice. Please try downloading and sharing manually.")}finally{s&&(s.style.display="flex")}},ae=()=>{if(!V){m.error("Images are still loading. Please try again in a moment.");return}const s=document.querySelector("#invoice-actions");s&&(s.style.display="none"),setTimeout(async()=>{try{const n=(await M(k.current,{scale:1.5,quality:.8,logging:!1,useCORS:!0,backgroundColor:"#FFFFFF"})).toDataURL("image/jpeg",.8),a=new z("p","mm","a5"),c=a.internal.pageSize.getWidth(),b=a.getImageProperties(n),S=b.height*c/b.width;a.addImage(n,"JPEG",0,0,c,S),a.save(`invoice_${l._id}.pdf`)}catch{m.error("Error generating PDF")}finally{s&&(s.style.display="flex")}},200)},re=async()=>{if(!p.name||!/^\d{10}$/.test(p.mobile)){m.error("Please enter valid name and 10-digit mobile number.");return}try{const s={_id:`Invoice_${Math.floor(1e3+Math.random()*9e3)}`,customer:p,billDate:new Date().toISOString(),order:o.map(t=>({productName:t.name,price:t.price,quantity:t.orderQuantity,totalPrice:t.totalPrice})),total:C};w(s),v(!0)}catch(s){m.error("Something went wrong: "+s.message)}},P=async()=>{const s={customer:p,billDate:G,order:o.map(t=>({productName:t.name,price:t.price,quantity:t.orderQuantity,totalPrice:t.totalPrice})),total:C,businessEmail:i?.businessEmail||""};try{await D.post("https://mims-backend-x0i3.onrender.com/save-bill",s),m.success("Bill Saved Successfully!"),F({name:"",mobile:"91",email:""}),f([]),I(0),R(),v(!1)}catch(t){console.error("Error saving bill:",t)}},ie=async()=>{await P(),l&&await O()};return e.jsxs(xe,{children:[e.jsx(pe,{title:"Billing | easyinventory",description:"Manage and generate invoices, download PDFs, and share billing details with customers easily using easyinventory.",keywords:"billing, invoices, invoice pdf, share invoice, easyinventory",url:"https://easyinventory.online/billing"}),e.jsx("div",{className:"text-sm text-gray-600 mb-4 dark:text-white",children:e.jsxs("nav",{className:"flex items-center space-x-2 dark:text-white",children:[e.jsx(he,{to:"/home",children:e.jsx(ue,{fontSize:20})}),e.jsx("span",{className:"text-gray-400 dark:text-white",children:"/"}),e.jsx("span",{className:"font-semibold text-gray-800 dark:text-white",children:"Billing"})]})}),e.jsxs("div",{className:"p-4 md:p-6 bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors",children:[e.jsx("input",{type:"hidden",name:"businessEmail",value:i?.businessEmail||"",readOnly:!0}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6 transition-colors",children:["name","mobile","email"].map((s,t)=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-600 dark:text-white mb-1 capitalize",children:[s,":"]}),e.jsx("input",{type:s==="email"?"email":s==="mobile"?"tel":"text",name:s,placeholder:`Enter ${s}`,value:p[s],onChange:ee,className:"w-full border border-gray-300 rounded-md p-2 focus:outline-blue-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white",required:!0})]},t))}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6 transition-colors",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-600 dark:text-white mb-1",children:"Product:"}),e.jsxs("select",{value:d,onChange:s=>W(s.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-white dark:bg-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Select Product"}),E.filter(s=>!i||!i.businessEmail||s.email===i.businessEmail).map(s=>e.jsxs("option",{value:s._id,children:[s.name," - â‚¹",s.price.toFixed(2)]},s._id))]})]}),e.jsxs("div",{className:"w-full md:w-40",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-600 dark:text-white mb-1",children:"Quantity:"}),e.jsx("input",{type:"number",min:"1",value:x,onChange:s=>H(parseInt(s.target.value)||1),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-900 dark:text-white",required:!0})]}),e.jsx("div",{className:"w-full md:w-32 flex items-end",children:e.jsx("button",{onClick:Y,className:"w-full h-10 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-2 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",children:"ADD"})})]}),e.jsx("br",{}),d&&e.jsxs("div",{className:"md:col-span-2 flex w-full flex-col",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-600 dark:text-white mb-1",children:"Price:"}),e.jsxs("div",{className:"flex items-center gap-2 h-full",children:[e.jsx("button",{type:"button",onClick:()=>_(!u),className:`h-12 px-4 rounded-md text-sm font-medium transition-colors flex-shrink-0 ${u?"bg-green-600 text-white hover:bg-green-700":"bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600"}`,children:u?"Editing":"Edit"}),u&&e.jsx("input",{type:"number",min:"0",step:"0.01",placeholder:"New Price",value:g[d]||"",onChange:s=>{const t=parseFloat(s.target.value);N({...g,[d]:isNaN(t)?"":t})},className:"h-12 w-full border border-gray-300 dark:border-gray-600 rounded-md p-4 text-base bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]}),u&&e.jsx("div",{className:"mt-3 flex justify-end",children:e.jsx("button",{onClick:()=>{N({}),_(!1)},className:"text-sm bg-red-100 hover:bg-red-200 text-red-700 font-medium py-1 px-3 rounded-md transition-colors",children:"Reset All Prices"})})]}),o.length>0&&e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-2 mb-6 sm:p-0 transition-colors",children:e.jsxs("table",{className:"w-full text-center text-[10px] xs:text-xs sm:text-sm md:text-base table-fixed break-words",children:[e.jsx("thead",{className:"bg-gray-100 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4 dark:text-white whitespace-normal",children:"Product Name"}),e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4 dark:text-white whitespace-normal",children:"Price"}),e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4 dark:text-white whitespace-normal",children:"Quantity"}),e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4 dark:text-white whitespace-normal",children:"Total"}),e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4 dark:text-white whitespace-normal",children:"Actions"})]})}),e.jsx("tbody",{className:"dark:text-white",children:o.map(s=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-1 px-1 sm:px-2 capitalize whitespace-normal break-words",children:s.name}),e.jsxs("td",{className:"py-1 px-1 sm:px-2 text-blue-600 font-semibold whitespace-normal break-words",children:["â‚¹",s.price.toFixed(2)]}),e.jsx("td",{className:"py-1 px-1 sm:px-2 whitespace-normal break-words",children:s.orderQuantity}),e.jsxs("td",{className:"py-1 px-1 sm:px-2 whitespace-normal break-words",children:["â‚¹",s.totalPrice.toFixed(2)]}),e.jsx("td",{className:"py-2",children:e.jsx("button",{onClick:()=>Z(s._id),className:"bg-red-500 hover:bg-red-600 py-1 px-1 sm:px-2 whitespace-normal break-words",children:"Remove"})})]},s._id))})]})}),o.length>0&&e.jsxs("div",{className:"text-center mb-10 flex justify-center gap-4",children:[e.jsx("button",{onClick:re,className:"bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700",children:"Preview Invoice"}),e.jsx("button",{onClick:P,className:"bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700",children:"Save Bill"})]}),X?e.jsx("div",{className:"flex justify-center items-center py-10",children:e.jsx(q,{})}):j.length===0?e.jsx("div",{className:"flex justify-center items-center py-10",children:e.jsx("span",{className:"text-gray-500 dark:text-gray-300",children:"No recent bills found"})}):e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-2 mb-6 sm:p-0 transition-colors",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-800 dark:text-white",children:"Recent Orders"}),e.jsx("div",{className:"overflow-x-auto",children:j.length===0?e.jsxs("div",{className:"flex justify-center items-center py-10",children:[e.jsx(q,{}),e.jsx("span",{className:"ml-2 text-gray-500 dark:text-gray-300"})]}):e.jsxs("table",{className:"w-full text-center text-[10px] xs:text-xs sm:text-sm md:text-base table-fixed break-words",children:[e.jsx("thead",{className:"bg-gray-100 dark:bg-gray-700 dark:text-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4",children:"Customer Name"}),e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4",children:"Products"}),e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4",children:"Total Price"}),e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4",children:"Date"}),e.jsx("th",{className:"px-1 py-2 sm:px-2 sm:py-4",children:"Invoice"})]})}),e.jsx("tbody",{className:"dark:text-white",children:j.filter(s=>i&&i.businessEmail?s.businessEmail===i.businessEmail:!0).map(s=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-1 px-1 sm:px-2 capitalize",children:s.customer.name}),e.jsx("td",{className:"py-1 px-1 sm:px-2 capitalize",children:e.jsx("ul",{className:"list-decimal pl-4",children:s.order.map((t,n)=>e.jsxs("li",{children:[t.productName," (x",t.quantity,") - â‚¹",t.price]},n))})}),e.jsxs("td",{className:"py-1 px-1 sm:px-2 text-blue-600 font-semibold",children:["â‚¹",s.total]}),e.jsx("td",{className:"py-1 px-1 sm:px-2",children:new Date(s.billDate).toLocaleString()}),e.jsx("td",{className:"py-1 px-1 sm:px-2",children:e.jsx("button",{onClick:()=>se(s),children:e.jsx(ge,{className:"text-blue-600 text-xl"})})})]},s._id))})]})})]}),(B||l)&&l&&e.jsx("div",{className:"fixed w-1/2 inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white text-black p-4 rounded shadow-lg w-full max-w-[850px] max-h-[90vh] overflow-auto",children:[e.jsxs("div",{ref:k,className:"p-4",children:[e.jsx("style",{children:`  
              body {  
                font-family: 'Helvetica', Arial, sans-serif;  
                background-color: #f8e1e1;  
                margin: 0;  
                padding: 0;  
              }  
              .invoice-container {  
                max-width: 800px;  
                margin: 0 auto;  
                background: #fff;  
                padding: 25px;  
                border-radius: 10px;  
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);  
                font-family: 'Helvetica', Arial, sans-serif;  
              }  
              .header {  
                text-align: center;  
                border-bottom: 2px solid #f0b8b8;  
                padding-bottom: 15px;  
                margin-bottom: 25px;  
              }  
              .header h1 {  
                margin: 10px 0;  
                font-size: 26px;  
                color: #d32f2f;  
              }  
              .header p {  
                margin: 5px 0;  
                color: #444;  
              }  
              .invoice-details, .customer-details {  
                display: flex;  
                justify-content: space-between;  
                margin-bottom: 25px;  
                font-size: 14px;  
              }  
              .invoice-details div, .customer-details div {  
                width: 48%;  
              }  
              table {  
                width: 100%;  
                border-collapse: collapse;  
                margin-bottom: 25px;  
              }  
              th, td {  
                border: 1px solid #f0b8b8;  
                padding: 10px;  
                text-align: left;  
              }  
              th {  
                background-color: #d32f2f;  
                color: #fff;  
              }  
              .total {  
                text-align: right;  
                font-weight: bold;  
                font-size: 16px;  
                color: #b71c1c;  
                margin-top: 10px;  
              }  
              .footer {  
                text-align: center;  
                margin-top: 25px;  
                font-size: 13px;  
                color: #666;  
                border-top: 1px solid #f0b8b8;  
                padding-top: 15px;  
              }  
              .stamp {  
                text-align: center;  
                margin-top: 20px;  
              }  
              .stamp img {  
                max-width: 120px;  
                margin: 10px 0;  
              }  
            `}),e.jsxs("div",{className:"invoice-container",children:[e.jsxs("div",{className:"header",children:[e.jsxs("div",{className:"flex flex-row-reverse w-full p-2",children:[e.jsx("div",{className:"w-9/12",children:e.jsx("h1",{className:"text-10xl font-extrabold text-center ",children:i?.businessName||"Business Name"})}),e.jsx("div",{className:"w-3/12 flex items-center",children:e.jsx("img",{className:"block m-auto -top-4 w-full h-full",src:i?.businessLogo?`https://mims-backend-x0i3.onrender.com${i.businessLogo}`:"Please upload your business logo",alt:"Business Logo"})})]}),e.jsxs("div",{children:[e.jsx("p",{children:i?.businessAddress||"Business Address"}),e.jsxs("p",{children:[e.jsxs("span",{children:["Phone: ",i?.businessMobile||""]}),e.jsxs("span",{children:[" |  Email: ",i?.businessEmail||""]})]})]})]}),e.jsxs("div",{className:"invoice-details",children:[e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Invoice Number:"})," INV-",l?._id?l._id.slice(-6).toUpperCase():""]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",l?.billDate?new Date(l.billDate).toDateString():""]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"hidden",children:[e.jsx("strong",{children:"Due Date:"})," ",l?.billDate?new Date(new Date(l.billDate).getTime()+7*864e5).toDateString():""]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Payment Terms:"})," Payment Receipt"]})]})]}),e.jsx("div",{className:"customer-details",children:e.jsxs("div",{children:[e.jsx("p",{children:e.jsx("strong",{children:"Customer Details:"})}),e.jsx("p",{children:l?.customer?.name||""}),e.jsxs("p",{children:["Email: ",l?.customer?.email||""]}),e.jsxs("p",{children:["Mobile: ",l?.customer?.mobile||""]})]})}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{children:"Unit Price"}),e.jsx("th",{children:"Total"})]})}),e.jsx("tbody",{children:l?.order&&l.order.length>0?l.order.map((s,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.productName}),e.jsx("td",{children:s.quantity}),e.jsxs("td",{children:["â‚¹",s.price]}),e.jsxs("td",{children:["â‚¹",s.totalPrice]})]},t)):e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"text-center",children:"No products found"})})})]}),e.jsx("div",{className:"total",children:e.jsxs("p",{children:["Total: â‚¹",l?.total||0]})}),e.jsxs("div",{className:"footer flex flex-col md:flex-row justify-between mt-0 items-center",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{children:["Thank you for shopping at ",i?.businessName||"Business Name","!"]}),e.jsx("p",{children:"Terms: All sales are final. Contact us for warranty details."})]}),e.jsx("div",{className:"stamp",children:e.jsx("img",{className:"w-24 h-24 md:w-32 md:h-32 object-contain",src:i?.businessStamp?`https://mims-backend-x0i3.onrender.com${i.businessStamp}`:"Please upload your business stamp",alt:"Shop Stamp"})})]})]})]}),e.jsxs("div",{id:"invoice-actions",className:"flex flex-wrap justify-end gap-3 mt-4 p-4 sticky bottom-0 bg-white",children:[B?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ie,className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",children:"Save Bill & Share"}),e.jsx("button",{onClick:P,className:"bg-blue-600 hidden text-white px-4 py-2 rounded hover:bg-blue-700",children:"Save Bill Only"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ae,className:"bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700",children:"Download PDF"}),e.jsx("button",{onClick:O,className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",children:"Share via WhatsApp"})]}),e.jsx("button",{onClick:te,className:"bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600",children:"Close"})]})]})}),e.jsx(be,{})]})]})};export{ve as default};
